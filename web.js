const express = require('express');
const axios = require('axios');
const cors = require('cors');
const fs = require('fs');
const path = require('path');
const crypto = require('crypto');
const { GoogleGenerativeAI } = require("@google/generative-ai");

const app = express();

// 1. ë¯¸ë“¤ì›¨ì–´ ë° ìš©ëŸ‰ ì„¤ì • (ëŒ€ìš©ëŸ‰ ë“±ê¸°ë¶€ PDF ìˆ˜ì‹  ëŒ€ë¹„)
app.use(express.json({ limit: '100mb' }));
app.use(express.urlencoded({ limit: '100mb', extended: true }));
app.use(cors());
app.use(express.static('public'));

// 2. ë¦¬í¬íŠ¸ ì €ì¥ í´ë” ìë™ ìƒì„±
const REPORT_DIR = path.join(__dirname, 'public/reports');
if (!fs.existsSync(REPORT_DIR)) {
    fs.mkdirSync(REPORT_DIR, { recursive: true });
}

// ==========================================
// 3. ì„¤ì • ì •ë³´ (HKey ë° í•˜ì´í”ˆ ê³„ì •)
// ==========================================
const CONFIG = {
    HKEY: '130e008d28511f21',
    USER_ID: 'snow89',
    HYPHEN_ID: 'snow89',
    HYPHEN_PW: '10dnjf2djr!',
    PAY_NO: 'V37642074050',
    PAY_PW: '10dnjf',
    GEMINI_API_KEY: 'AIzaSyBQA5y7Ttpck8kQPiezs7Ti6geQ-yDxVAM', 
};

// ============================================================
// [ìµœì¢…ë³¸] ê°€ë…ì„± ê·¹ëŒ€í™” ë° ì¼€ì´ìŠ¤ë³„ ì •ë°€ ë¡œì§ ë°˜ì˜ í”„ë¡¬í”„íŠ¸
// ============================================================
const DAMBAEK_PROMPT = `
# [ë‹´ë°±ìŠ¤í€˜ì–´(ì£¼) ëŒ€ì¶œë¹„ì„œ] ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸

## 1. ê¸°ë³¸ ì—­í• 
- ì‚¬ìš©ì ì…ë ¥ ë°ì´í„°ì™€ ë“±ê¸°ë¶€ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ëŒ€ì¶œ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•œë‹¤.
- **ì¶œë ¥ ì›ì¹™:** ì•„ë˜ [ìµœì¢… ë¦¬í¬íŠ¸ í…œí”Œë¦¿]ì˜ ì–‘ì‹ì„ ì—„ê²©íˆ ì¤€ìˆ˜í•œë‹¤. 
- **ê°„ê²© ìœ ì§€:** êµ¬ë¶„ì„ (â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€)ì˜ ìœ„ì™€ ì•„ë˜, ê·¸ë¦¬ê³  ê° ì¼€ì´ìŠ¤(CASE) ì‚¬ì´ì—ëŠ” ë°˜ë“œì‹œ **'ë¹ˆ ì¤„(ê³µë°± ë¼ì¸)'ì„ ì‚½ì…**í•˜ì—¬ ê°€ë…ì„±ì„ ë†’ì¸ë‹¤.
- **ê°•ì¡° í‘œê¸°:** ì£¼ìš” ê¸ˆì•¡ê³¼ í•œë„ëŠ” **ê°•ì¡°(Bold)** ì²˜ë¦¬í•œë‹¤.

## 2. ë°ì´í„° ì²˜ë¦¬ ë° ìš°ì„ ìˆœìœ„
1. **ê¸°ëŒ€ì¶œ:** ì‚¬ìš©ì ì…ë ¥ê°’ ì ˆëŒ€ ìš°ì„ . (ì…ë ¥ ì—†ì„ ì‹œ PDF ì„êµ¬ ê¸°ì¤€)
2. **ì‹œì„¸:** ì‚¬ìš©ì ì…ë ¥ê°’(KBì‹œì„¸) ì‚¬ìš©.
3. **ë©´ì :** ì‚¬ìš©ì ì…ë ¥ê°’ ìš°ì„  > ì—†ìœ¼ë©´ PDF í‘œì œë¶€ ì „ìœ ë¶€ë¶„ ë©´ì  ì‚¬ìš©.

## 3. ì¼€ì´ìŠ¤ë³„ ì •ë°€ ë¡œì§ ê°€ì´ë“œ
- **[ë°©ê³µì œ]:** ì„œìš¸(5500), ê³¼ë°€(4800), ê´‘ì—­ì‹œ/ì£¼ìš”ë„ì‹œ(2800), ê¸°íƒ€(2500).
- **[Case 1] ìƒì• ìµœì´ˆ:** MIN(KBì‹œì„¸ Ã— 80%, 60,000ë§Œì›). (ìµœëŒ€ 6ì–µ ìƒí•œ ê³ ì •)
- **[Case 2] ì¼ë°˜ë§¤ë§¤:** - **ê·œì œì§€ì—­:** ì„œìš¸(ì „ì—­), ê²½ê¸° ì„±ë‚¨(ë¶„ë‹¹/ìˆ˜ì •/ì¤‘ì›), ìˆ˜ì›(ì˜í†µ/ì¥ì•ˆ/íŒ”ë‹¬), ìš©ì¸(ìˆ˜ì§€), ì•ˆì–‘(ë™ì•ˆ), ê³¼ì²œ, ê´‘ëª…, ì˜ì™•, í•˜ë‚¨.
  - **ê·œì œì§€ì—­ í•œë„:** ì‹œì„¸ 15ì–µ ì´í•˜(ì‹œì„¸ 40%, Max 6ì–µ) / 15ì–µ~25ì–µ(4ì–µ ê³ ì •) / 25ì–µ ì´ˆê³¼(2ì–µ ê³ ì •).
  - **ë¹„ê·œì œì§€ì—­:** ì‹œì„¸ Ã— 70% (ìƒí•œ ì—†ìŒ).
- **[Case 3] ì „ì„¸í‡´ê±°:** ê·œì œì§€ì—­(1ì£¼íƒ 40%, ë‹¤ì£¼íƒ 30%) / ë¹„ê·œì œì§€ì—­(ëª¨ë‘ 60%).

## 4. ìµœì¢… ë¦¬í¬íŠ¸ í…œí”Œë¦¿ (ì—¬ë°± ë° ê°•ì¡° ì–‘ì‹ ì—„ê²© ì¤€ìˆ˜)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ¢ **ë‹´ë°±ìŠ¤í€˜ì–´(ì£¼) ëŒ€ì¶œë¹„ì„œ ë¦¬í¬íŠ¸**

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ“ **1. ê¸°ë³¸ ì •ë³´**

* ì†Œìœ ì: **{ì†Œìœ ìëª…}** ë‹˜
* ì£¼ì†Œ: {ì „ì²´ ì£¼ì†Œ}
* ì „ìš©ë©´ì : {ì „ìš©ë©´ì }ã¡
* KBì‹œì„¸: **{KBì‹œì„¸}ë§Œì›**

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ’³ **2. ê¸°ëŒ€ì¶œ ë° ìì‚° í‰ê°€**

{ìˆœìœ„}ìˆœìœ„. {ì€í–‰ëª…}: ì›ê¸ˆ {ì›ê¸ˆ}ë§Œì› / ì±„ê¶Œìµœê³ ì•¡ {ì±„ê¶Œì•¡}ë§Œì› ({ë¹„ìœ¨}%)

* **ì´ ì›ê¸ˆí•©ê³„:** **{ì›ê¸ˆí•©ê³„}ë§Œì›**
* **ì´ ì±„ê¶Œìµœê³ ì•¡ í•©ê³„:** **{ì±„ê¶Œìµœê³ ì•¡í•©ê³„}ë§Œì›**
* **ìˆœìì‚°:** **{ìˆœìì‚°}ë§Œì›** (ì‹œì„¸ - ì´ì›ê¸ˆ)
* **ëŒ€ì¶œë¹„ìœ¨(LTV):** **{LTVë¹„ìœ¨}%** (í˜„ì¬ ì‹œì„¸ ëŒ€ë¹„ ì´ ì›ê¸ˆ ë¹„ìœ¨)

**[ëŒ€ì¶œ LTV ê¸ˆì•¡ë³„ ì˜ˆìƒí‘œ]**

**ã… ìƒí˜¸ê¸ˆìœµ (ë°©ê³µì œ ì ìš©)**
* LTV 80%: {LTV80_ê¸ˆì•¡}ë§Œì› - {ë°©ê³µì œì•¡}ë§Œì› = **{ê³„ì‚°ê²°ê³¼}ë§Œì›**
* LTV 85%: {LTV85_ê¸ˆì•¡}ë§Œì› - {ë°©ê³µì œì•¡}ë§Œì› = **{ê³„ì‚°ê²°ê³¼}ë§Œì›**

**ã… ì €ì¶•ì€í–‰/ìºí”¼íƒˆ (ë°©ê³µì œ ë¯¸ì ìš©)**
* LTV 80%: **{LTV80_ê¸ˆì•¡}ë§Œì›**
* LTV 85%: **{LTV85_ê¸ˆì•¡}ë§Œì›**
* LTV 90%: **{LTV90_ê¸ˆì•¡}ë§Œì›**

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ“Š **3. ëŒ€ì¶œ í•œë„ ë° ì›”ë‚©ì…ê¸ˆ (ì˜ˆìƒ)**


**[ì¼€ì´ìŠ¤1] ìƒì• ìµœì´ˆ ë§¤ë§¤ì”ê¸ˆ (êµ¬ì…ìê¸ˆ)**

* í•œë„: **{C1_í•œë„}ë§Œì›** (LTV 80% ì´ë‚´, ìµœëŒ€ 6ì–µì› ì ìš©)
* 1ê¸ˆìœµ: ê¸ˆë¦¬ 4.3%~ / ì›” ì›ë¦¬ê¸ˆ {C1_ì›”1}ë§Œì› / í•„ìš”ì†Œë“ ì•½ **{C1_ì†Œë“1}ë§Œì›**
* 2ê¸ˆìœµ: ê¸ˆë¦¬ 4.0%~ / ì›” ì›ë¦¬ê¸ˆ {C1_ì›”2}ë§Œì› / í•„ìš”ì†Œë“ ì•½ **{C1_ì†Œë“2}ë§Œì›**


**[ì¼€ì´ìŠ¤2] ì¼ë°˜ ë§¤ë§¤ì”ê¸ˆ (ë¬´ì£¼íƒ/1ì£¼íƒ ì²˜ë¶„)**

* í•œë„: **{C2_í•œë„}ë§Œì›** ({ì§€ì—­êµ¬ë¶„} ì ìš© / {C2_ìƒí•œë¡œì§} ê¸°ì¤€)
* 1ê¸ˆìœµ: ê¸ˆë¦¬ 4.3%~ / ì›” ì›ë¦¬ê¸ˆ {C2_ì›”1}ë§Œì› / í•„ìš”ì†Œë“ ì•½ **{C2_ì†Œë“1}ë§Œì›**
* 2ê¸ˆìœµ: ê¸ˆë¦¬ 4.0%~ / ì›” ì›ë¦¬ê¸ˆ {C2_ì›”2}ë§Œì› / í•„ìš”ì†Œë“ ì•½ **{C2_ì†Œë“2}ë§Œì›**


**[ì¼€ì´ìŠ¤3] ì „ì„¸í‡´ê±°ìê¸ˆ (ë³´ì¦ê¸ˆ ë°˜í™˜)**

* â‘  **1ì£¼íƒì** (LTV {C3A_LTV}%): **{C3A_í•œë„}ë§Œì›** / 1ê¸ˆìœµì†Œë“ **{C3A_ì†Œë“1}ë§Œì›**
* â‘¡ **ë‹¤ì£¼íƒì** (LTV {C3B_LTV}%): **{C3B_í•œë„}ë§Œì›** / 2ê¸ˆìœµì†Œë“ **{C3B_ì†Œë“2}ë§Œì›**
* ë¹„ê³ : {ì§€ì—­ëª…} ({ê·œì œì—¬ë¶€}) ê¸°ì¤€ ì ìš©


**[ì¼€ì´ìŠ¤4] ì‚¬ì—…ì ë‹´ë³´ëŒ€ì¶œ (í›„ìˆœìœ„/ìƒí™œìê¸ˆ)**

**ã… ìƒí˜¸ê¸ˆìœµ (LTV 80% - ë°©ê³µì œ)**
* í•œë„: **{C4A_í•œë„}ë§Œì›**
* ì˜ˆìƒê¸ˆë¦¬: 4.9%~ / ì›” ì´ì: ì•½ **{C4A_ì´ì}ë§Œì›** (ì´ìë§Œ ë‚©ë¶€)
* ê³„ì‚°ì‹: ({80%ê¸ˆì•¡} - {ë°©ê³µì œì•¡}) - {ì„ ìˆœìœ„ì±„ê¶Œì´ì•¡}

**ã… ì €ì¶•/ìºí”¼íƒˆ (LTV 90%)**
* í•œë„: **{C4B_í•œë„}ë§Œì›**
* ì˜ˆìƒê¸ˆë¦¬: 8.5%~ / ì›” ì´ì: ì•½ **{C4B_ì´ì}ë§Œì›** (ì´ìë§Œ ë‚©ë¶€)


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â• **[ì¼€ì´ìŠ¤5] í›„ìˆœìœ„ ì¶”ê°€ ëŒ€ì¶œ**

* ìƒí˜¸ê¸ˆìœµ (80%): ê°€ìš©í•œë„ **{C5A_í•œë„}ë§Œì›**
* ì €ì¶•/ìºí”¼íƒˆ (90%): ê°€ìš©í•œë„ **{C5B_í•œë„}ë§Œì›**
* ë¹„ê³ : ê¸°ì¡´ ì„ ìˆœìœ„ ì±„ê¶Œìµœê³ ì•¡ {ê¸°ì¡´ì±„ê¶Œí•©ê³„}ë§Œì› ìœ ì§€ ê°€ì •


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ”„ **[ì¼€ì´ìŠ¤6] í†µëŒ€í™˜ (ê°ˆì•„íƒ€ê¸°)**

* ìƒí˜¸ê¸ˆìœµ (80%): ìµœëŒ€ **{C6A_í•œë„}ë§Œì›** / ì—¬ìœ ìê¸ˆ **{C6A_ê°€ìš©}ë§Œì›**
* ì €ì¶•/ìºí”¼íƒˆ (90%): ìµœëŒ€ **{C6B_í•œë„}ë§Œì›** / ì—¬ìœ ìê¸ˆ **{C6B_ê°€ìš©}ë§Œì›**
* ë¹„ê³ : ê¸°ì¡´ ëŒ€ì¶œ ì „ì•¡ ìƒí™˜ í›„ ì‹ ê·œ ì‹¤í–‰ ê°€ì •


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âš ï¸ **ì•ˆë‚´ì‚¬í•­**

* ë³¸ ë¦¬í¬íŠ¸ëŠ” ì…ë ¥í•˜ì‹  ì •ë³´ì™€ KBì‹œì„¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ë‹¨ìˆœ ì˜ˆìƒì¹˜ì…ë‹ˆë‹¤.
* ì°¨ì£¼(ê³ ê°)ì˜ ì‹ ìš©ì ìˆ˜, ì†Œë“, ë¬¼ê±´ì§€ ìƒí™©ì— ë”°ë¼ ì‹¤ì œ í•œë„ ë° ê¸ˆë¦¬ëŠ” ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* ì •í™•í•œ ì‹¬ì‚¬ë¥¼ ìœ„í•´ ë‹´ë‹¹ìì—ê²Œ ë¬¸ì˜ ë°”ëë‹ˆë‹¤.

ğŸ“ **ìƒë‹´ë¬¸ì˜: ë°•ìˆœí˜¸ ëŒ€í‘œ (010-3950-6886)**
**ë‹´ë°±ìŠ¤í€˜ì–´(ì£¼) ëŒ€ì¶œë¹„ì„œ**

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
`;

// 1. ëª¨ë¸ ì„¤ì • ë‹¨ê³„ì—ì„œ 'ì°½ì˜ì„±'ì„ ì™„ì „íˆ ë•ë‹ˆë‹¤.
const model = genAI.getGenerativeModel({
    model: "gemini-2.0-flash",
    systemInstruction: DAMBAEK_PROMPT,
    generationConfig: {
        temperature: 0, // 0ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ì§€ì¹¨ì„ ì–´ê¸¸ í™•ë¥ ì´ ê±°ì˜ ì‚¬ë¼ì§‘ë‹ˆë‹¤.
        topP: 0.1,
        maxOutputTokens: 2048,
    }
});

// 2. ë¶„ì„ ë¼ìš°íŠ¸: ì˜ˆì‹œ(Few-Shot)ë¥¼ í¬í•¨í•˜ì—¬ AIì˜ ë‡Œë¥¼ ê³ ì •í•©ë‹ˆë‹¤.
app.post('/api/analyze', async (req, res) => {
    try {
        let { registryData, userInputs } = req.body;
        
        // ë©´ì  ë³´ì •
        const correctArea = extractExclusiveArea(Array.isArray(registryData) ? registryData : []);
        if (correctArea) userInputs.area = correctArea;

        // [ìµœì¢… ë³‘ê¸°] ëª¨ë²” ì‚¬ë¡€(Example)ë¥¼ í”„ë¡¬í”„íŠ¸ì— ì§ì ‘ ë°•ì•„ë„£ìŠµë‹ˆë‹¤.
        const prompt = `
            ë„ˆëŠ” ì•„ë˜ [ì…ë ¥ê°’]ì„ ë°›ì•„ì„œ ë°˜ë“œì‹œ [ì¶œë ¥ ì˜ˆì‹œ]ì™€ ë˜‘ê°™ì€ ì„œì‹ìœ¼ë¡œë§Œ ëŒ€ë‹µí•˜ëŠ” ëŒ€ì¶œ ë¶„ì„ ê¸°ê³„ë‹¤. 
            ì„œìˆ í˜• ì„¤ëª…ì´ë‚˜ ì¸ì‚¬ë§ì€ ì ˆëŒ€ë¡œ í•˜ì§€ ë§ˆë¼.

            [ì¶œë ¥ ì˜ˆì‹œ]
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 
            ğŸ¢ ë‹´ë°±ìŠ¤í€˜ì–´(ì£¼) ëŒ€ì¶œë¹„ì„œ ë¦¬í¬íŠ¸ 
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 
            ğŸ“ 1. ê¸°ë³¸ ì •ë³´
            ì†Œìœ ì: í™ê¸¸ë™ ë‹˜
            ì£¼ì†Œ: ì„œìš¸ì‹œ ê°•ë‚¨êµ¬...
            ... (ì¤‘ëµ) ...

            [ì‹¤ì œ ì…ë ¥ê°’]
            ì†Œìœ ìëª…: ${userInputs.ownerName || 'ë°•ìˆœí˜¸'}
            ì£¼ì†Œ: ${userInputs.address}
            KBì‹œì„¸: ${userInputs.kbPrice}ë§Œì›
            ì „ìš©ë©´ì : ${userInputs.area}ã¡
            ê¸°ëŒ€ì¶œ: ${JSON.stringify(userInputs.loans)}
            ë“±ê¸°ë¶€: ${JSON.stringify(registryData).substring(0, 6000)}

            ì´ì œ ìœ„ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹œìŠ¤í…œ ì§€ì¹¨ì˜ í…œí”Œë¦¿ ì–‘ì‹ëŒ€ë¡œ ë¦¬í¬íŠ¸ë¥¼ ì™„ì„±í•˜ë¼.
        `;

        const result = await model.generateContent(prompt);
        let finalAnalysis = result.response.text();

        // ë§Œì•½ AIê°€ ì—¬ì „íˆ ì„œìˆ í˜• ì œëª©ì„ ë¶™ì¸ë‹¤ë©´ ê°•ì œë¡œ ì˜ë¼ë‚´ëŠ” ë¡œì§ (ë³´ì™„ì±…)
        if (finalAnalysis.includes('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€')) {
            finalAnalysis = finalAnalysis.substring(finalAnalysis.indexOf('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'));
        }

        res.json({ success: true, analysis: finalAnalysis });
    } catch (e) { 
        console.error("ë¶„ì„ ì—ëŸ¬:", e);
        res.status(500).json({ success: false }); 
    }
});

// ==========================================
// 5. ì „ìš©ë©´ì  ì •ë°€ ì¶”ì¶œ í•¨ìˆ˜
// ==========================================
function extractExclusiveArea(outList) {
    if (!outList || !Array.isArray(outList)) return null;
    const cleanText = outList.map(item => JSON.stringify(item)).join('').replace(/\\n/g, '').replace(/\s/g, '');
    const sections = cleanText.split('ì „ìœ ë¶€ë¶„');
    if (sections.length < 2) return null;
    const match = sections[1].match(/(\d+\.\d+)/);
    return match ? match[0] : null;
}

// ==========================================
// 6. API ë¼ìš°íŠ¸
// ==========================================

// ì£¼ì†Œ ê²€ìƒ‰
app.post('/api/search', async (req, res) => {
    try {
        const { address } = req.body;
        console.log(`ğŸ” [ê²€ìƒ‰ ìš”ì²­] ${address}`);
        const response = await axios.post('https://api.hyphen.im/in0004000168', {
            kindcls: '', admin_regn1: '', cls_flag: 'í˜„í–‰', simple_address: address, detailYn: '', limitPage: '10', pageNo: '1'
        }, { headers: { 'Content-Type': 'application/json', 'Hkey': CONFIG.HKEY, 'User-Id': CONFIG.USER_ID }, timeout: 20000 });
        res.json({ success: true, list: response.data.data ? response.data.data.list : [] });
    } catch (e) { res.status(500).json({ success: false }); }
});

// ë¯¼ì›ìºì‹œ ë°œê¸‰ (ì•ˆì •ì ì¸ ì˜ˆì „ ì½”ë“œ ë°©ì‹)
app.post('/api/issue', async (req, res) => {
    try {
        const { uniqNo } = req.body;
        console.log(`ğŸ“„ [ë°œê¸‰ ì‹œë„] ê³ ìœ ë²ˆí˜¸: ${uniqNo}`);
        
        const response = await axios.post('https://api.hyphen.im/in0004000948', {
            userId: CONFIG.HYPHEN_ID, userPw: CONFIG.HYPHEN_PW, userPwEnc: CONFIG.HYPHEN_PW,
            searchDiv: 'uniqNo', uniqNo: uniqNo, payDiv: '0', payNo: CONFIG.PAY_NO, payPw: CONFIG.PAY_PW, payPwEnc: CONFIG.PAY_PW,
            pdfHex: 'Y', xmlYn: 'N', display: '1', cmortCheck: '', tradeCheck: '', dupChk: '', excRegYn: '', closingYn: '', kindcls: '', kindclsYn: ''
        }, { 
            headers: { 'Content-Type': 'application/json', 'Hkey': CONFIG.HKEY, 'User-Id': CONFIG.USER_ID },
            timeout: 60000 
        });

        const result = response.data;

        if (result.common && result.common.errYn === 'Y') {
            console.log("âŒ í•˜ì´í”ˆ ë°œê¸‰ ì‹¤íŒ¨:", result.common.errMsg);
            res.json({ success: false, msg: result.common.errMsg });
        } else if (result.data && result.data.pdfHexString) {
            console.log("âœ… í•˜ì´í”ˆ ë°œê¸‰ ì„±ê³µ");
            const outList = result.data.outList || [];
            const parsedArea = extractExclusiveArea(outList);
            res.json({ 
                success: true, 
                pdfHex: result.data.pdfHexString, 
                info: outList, 
                parsedArea 
            });
        } else {
            res.json({ success: false, msg: "ë°ì´í„° ìˆ˜ì‹  ì˜¤ë¥˜" });
        }
    } catch (e) { 
        console.error("ğŸ”¥ í†µì‹  ì—ëŸ¬:", e.message); 
        res.status(500).json({ success: false, msg: 'í•˜ì´í”ˆ í†µì‹  ì‹¤íŒ¨' }); 
    }
});

// [ìµœì¢… ìˆ˜ì •] ë°ì´í„° íë¦„ ë§¤ì¹­ ë° í…œí”Œë¦¿ ì¶œë ¥ ê°•ì œí™” ë¡œì§
app.post('/api/analyze', async (req, res) => {
    try {
        let { registryData, userInputs } = req.body;
        
        // ë©´ì  ë³´ì •
        const correctArea = extractExclusiveArea(Array.isArray(registryData) ? registryData : []);
        if (correctArea) userInputs.area = correctArea;

        // [ìµœí›„ì˜ ìˆ˜ë‹¨] AIì—ê²Œ ì¤„ë°”ê¿ˆê³¼ í…œí”Œë¦¿ ì¤€ìˆ˜ë¥¼ ìœ„í•´ 'ë°˜ë§'ê³¼ 'ê°•ë ¥í•œ ê²½ê³ 'ë¥¼ ì„ì–´ ëª…ë ¹í•©ë‹ˆë‹¤.
        const prompt = `
            ë„ˆì˜ ì„ë¬´ëŠ” ì•„ë˜ [ì…ë ¥ ë°ì´í„°]ë¥¼ ì‚¬ìš©í•˜ì—¬ [ìµœì¢… ë¦¬í¬íŠ¸ í…œí”Œë¦¿]ì˜ ë¹ˆì¹¸ì„ ì±„ìš°ëŠ” ê²ƒì´ë‹¤.
            
            [ì ˆëŒ€ ê·œì¹™]
            1. ë¦¬í¬íŠ¸ì˜ ì‹œì‘ì€ ë°˜ë“œì‹œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë¡œ ì‹œì‘í•˜ë¼.
            2. í…œí”Œë¦¿ì— ì—†ëŠ” ì„¤ëª…, ë¶„ì„ ì˜ê²¬, Disclaimer ë“±ì€ ë‹¨ í•œ ê¸€ìë„ ì ì§€ ë§ˆë¼.
            3. ëª¨ë“  ì¼€ì´ìŠ¤(1~6)ë¥¼ ë¹ ì§ì—†ì´ í¬í•¨í•˜ë¼.
            4. ì¤„ë°”ê¿ˆ ê·œì¹™ì„ ì—„ê²©íˆ ì¤€ìˆ˜í•˜ë¼.

            [ì…ë ¥ ë°ì´í„°]
            ì†Œìœ ìëª…: ${userInputs.ownerName || 'ë°•ìˆœí˜¸'}
            ì£¼ì†Œ: ${userInputs.address}
            KBì‹œì„¸: ${userInputs.kbPrice}
            ì „ìš©ë©´ì : ${userInputs.area}
            ê¸°ëŒ€ì¶œ: ${JSON.stringify(userInputs.loans)}
            ë“±ê¸°ë¶€: ${JSON.stringify(registryData).substring(0, 5000)}

            [ìµœì¢… ë¦¬í¬íŠ¸ í…œí”Œë¦¿]
            ${DAMBAEK_PROMPT}
        `;

        const result = await model.generateContent(prompt);
        res.json({ success: true, analysis: result.response.text() });
    } catch (e) { 
        res.status(500).json({ success: false }); 
    }
});

// ê³µìœ  URL ì €ì¥
app.post('/api/share', (req, res) => {
    try {
        const { pdfHex, aiText, metaData } = req.body;
        const reportId = crypto.randomBytes(4).toString('hex');
        const savePath = path.join(REPORT_DIR, reportId);
        if (!fs.existsSync(savePath)) fs.mkdirSync(savePath);
        fs.writeFileSync(path.join(savePath, 'data.json'), JSON.stringify({ aiText, metaData, pdfHex }));
        if (pdfHex) fs.writeFileSync(path.join(savePath, 'doc.pdf'), Buffer.from(pdfHex, 'hex'));
        res.json({ success: true, reportId });
    } catch (e) { res.status(500).json({ success: false }); }
});

const PORT = process.env.PORT || 8001; // ì‹œìŠ¤í…œì´ ì£¼ëŠ” í¬íŠ¸ ìš°ì„  ì‚¬ìš©

app.listen(PORT, "0.0.0.0", () => {
    console.log(`ğŸš€ ì„œë²„ ê°€ë™ ì¤‘ (Port: ${PORT})`);
});