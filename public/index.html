<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>담백스퀘어 대출비서 Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f0f2f5; color: #191f28; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #ccd3db; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }

        .toss-card { background: #ffffff; border-radius: 24px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04); border: 1px solid #e5e8eb; }
        .input-toss { width: 100%; padding: 10px; background-color: #f9fafb; border: 1px solid #e5e8eb; border-radius: 8px; font-size: 13px; font-weight: 600; color: #333d4b; text-align: right; transition: all 0.2s; }
        .input-toss:focus { background-color: #ffffff; border-color: #3182f6; outline: none; }
        .input-readonly { background-color: #f2f4f6; color: #3182f6; cursor: default; }
        .btn-primary { background: #3182f6; color: white; border-radius: 12px; font-weight: 700; transition: background 0.2s; }
        .btn-primary:hover { background: #1b64da; }
        
        .prose { max-width: none; color: #333d4b; font-family: 'Pretendard', sans-serif; line-height: 1.7; }
        .prose strong { color: #3182f6; font-weight: 800; }
        
        .auto-filled { animation: flash-blue 1.5s ease-out; border-color: #3182f6; background-color: #e8f3ff; }
        @keyframes flash-blue { 0% { background-color: #ffffd0; } 100% { background-color: #f9fafb; } }
        .drag-over { border-color: #3182f6 !important; background-color: #e8f3ff !important; color: #3182f6 !important; }

        .history-item { cursor: pointer; padding: 12px; border-radius: 12px; transition: all 0.2s; border: 1px solid transparent; }
        .history-item:hover { background-color: #f2f4f6; }
    </style>
</head>
<body class="min-h-screen flex p-4 gap-6 items-start"> 
    
    <aside class="w-64 bg-white rounded-2xl shadow-sm border border-gray-200 flex flex-col hidden lg:flex sticky top-4" style="height: calc(100vh - 2rem);">
        <div class="p-5 border-b border-gray-100 flex justify-between items-center flex-none">
            <h2 class="font-bold text-gray-800"><i class="fa-solid fa-clock-rotate-left mr-2 text-blue-600"></i>최근 조회</h2>
            <button onclick="clearHistory()" class="text-xs text-gray-400 hover:text-red-500">지우기</button>
        </div>
        <div id="historyList" class="flex-1 overflow-y-auto p-3 space-y-1">
            <div class="text-center text-gray-400 text-xs py-10">기록이 없습니다.</div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col min-w-0">
        <header class="flex justify-between items-center mb-6 px-2">
            <div class="flex items-center gap-2">
                <h1 class="text-2xl font-bold tracking-tight text-[#191f28]"><i class="fa-solid fa-building-columns text-blue-600 mr-2"></i>대출비서 Pro</h1>
            </div>
            <div><span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold">● 시스템 정상</span></div>
        </header>

        <div class="flex flex-col xl:flex-row gap-6 mb-8">
            <section class="w-full xl:w-5/12 flex flex-col toss-card overflow-hidden h-[780px]">
                <div class="p-5 border-b border-gray-100">
                    <h2 class="text-base font-bold mb-3">부동산 주소 검색 (동호수 포함)</h2>
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="addrInput" class="input-toss text-left" placeholder="예: 신월동 1077 211동 804호" onkeypress="if(event.keyCode==13) searchAddr()">
                        <button onclick="searchAddr()" class="btn-primary px-5 py-2 whitespace-nowrap">조회</button>
                    </div>
                    
                    <div id="dropZone" class="relative w-full h-80 border-2 border-dashed border-gray-300 rounded-xl text-gray-400 hover:border-blue-400 hover:text-blue-500 transition flex flex-col items-center justify-center cursor-pointer bg-gray-50"
                         onclick="document.getElementById('pdfUploadInput').click()">
                        <input type="file" id="pdfUploadInput" accept=".pdf" class="hidden" onchange="handleFileUpload(this.files)">
                        <i class="fa-solid fa-cloud-arrow-up text-5xl mb-4 text-blue-300"></i>
                        <span class="text-xl font-bold">PDF 파일 업로드</span>
                        <span class="text-sm text-gray-400 mt-2">클릭하거나 파일을 이곳으로 드래그하세요</span>
                    </div>
                </div>

                <div id="listArea" class="flex-1 overflow-y-auto p-4 space-y-2 relative bg-gray-50">
                    <div class="h-full flex flex-col items-center justify-center text-gray-400 absolute inset-0"><p>주소를 조회하거나 PDF를 업로드하세요.</p></div>
                </div>

                <div id="pdfControlPanel" class="hidden p-4 bg-white border-t border-gray-100 grid grid-cols-2 gap-3">
                    <button onclick="openPdfViewer()" class="py-3 rounded-xl bg-gray-100 hover:bg-gray-200 font-bold text-gray-700 text-sm"><i class="fa-solid fa-arrow-up-right-from-square mr-1"></i> 바로 열기(팝업)</button>
                    <button onclick="savePdfAsCustom()" class="py-3 rounded-xl bg-blue-600 hover:bg-blue-700 font-bold text-white text-sm"><i class="fa-solid fa-download mr-1"></i> PDF 저장</button>
                </div>
            </section>

            <section class="w-full xl:w-7/12 flex flex-col toss-card overflow-hidden h-[780px]">
                <div class="p-5 border-b border-gray-100 bg-white z-10 flex justify-between items-center">
                    <h2 class="text-base font-bold">권리 분석 데이터 입력</h2>
                    <button onclick="openKBLand()" class="bg-yellow-400 hover:bg-yellow-500 text-black font-bold px-5 py-3 rounded-xl shadow-md transition flex items-center text-sm transform hover:scale-105">
                        <i class="fa-solid fa-mobile-screen-button mr-2 text-lg"></i> KB시세 팝업
                    </button>
                </div>
                
                <div class="flex-1 overflow-y-auto p-6 space-y-6 bg-white">
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 shadow-sm">
                        <div class="grid grid-cols-12 gap-2 text-sm items-start">
                            <div class="col-span-2 font-bold text-gray-600 mt-0.5">소유자:</div>
                            <div class="col-span-10 font-bold text-blue-600 text-lg leading-none" id="displayOwner">-</div>
                            <div class="col-span-2 font-bold text-gray-600 mt-0.5">물건지:</div>
                            <div class="col-span-10 text-gray-800 break-keep font-medium leading-relaxed" id="displayAddress">-</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-600 mb-2">전용면적 <span class="text-green-500 text-xs">(자동)</span></label>
                            <div class="relative">
                                <input type="text" id="areaInput" class="input-toss text-lg text-gray-700" placeholder="00.00">
                                <span class="absolute right-4 top-3.5 text-gray-400 text-sm">㎡</span>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between items-end mb-2">
                                <label class="block text-sm font-bold text-gray-600">KB 시세 <span class="text-blue-500 text-xs">(필수)</span></label>
                                <span id="kbKoreanText" class="text-xs text-blue-600 font-bold"></span>
                            </div>
                            <div class="relative">
                                <input type="text" id="kbPrice" class="input-toss text-lg text-blue-600 border-blue-100 bg-blue-50" placeholder="0" onkeyup="formatMoney(this); updateKoreanMoney(this)">
                                <span class="absolute right-4 top-3.5 text-gray-400 text-sm">만원</span>
                            </div>
                        </div>
                    </div>

                    <div id="gapguSection" class="hidden">
                        <div class="flex justify-between items-end mb-2">
                            <label class="block text-sm font-bold text-red-600">
                                <i class="fa-solid fa-triangle-exclamation mr-1"></i>특이사항 (갑구)
                            </label>
                        </div>
                        <div class="bg-red-50 p-4 rounded-xl border border-red-200">
                            <ul id="gapguList" class="space-y-2"></ul>
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between items-end mb-2">
                            <label class="block text-sm font-bold text-gray-600">기대출 상세 내역 <span class="text-green-500 text-xs font-normal">(요약표 기반 최신반영)</span></label>
                            <span class="text-xs text-gray-400">단위: 만원</span>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                            <div class="grid grid-cols-12 gap-2 mb-2 text-xs text-gray-500 text-center font-bold">
                                <div class="col-span-1">순위</div><div class="col-span-3">근저당권자</div><div class="col-span-3">채권최고액</div><div class="col-span-2">설정비(%)</div><div class="col-span-3">대출원금</div>
                            </div>
                            <div id="loanInputs">
                                <div class="grid grid-cols-12 gap-2 mb-2 items-center"><div class="col-span-1 text-center font-bold text-sm">1순위</div><div class="col-span-3"><input type="text" id="bank1" class="input-toss bg-white text-center" placeholder="권리자"></div><div class="col-span-3"><input type="text" id="bond1" class="input-toss bg-white" placeholder="0" onkeyup="formatMoney(this); autoCalcPrincipal(1)"></div><div class="col-span-2"><input type="number" id="ratio1" class="input-toss bg-white text-center" value="120" onchange="autoCalcPrincipal(1)"></div><div class="col-span-3"><input type="text" id="principal1" class="input-toss input-readonly" placeholder="0" readonly></div></div>
                                <div class="grid grid-cols-12 gap-2 mb-2 items-center"><div class="col-span-1 text-center font-bold text-sm">2순위</div><div class="col-span-3"><input type="text" id="bank2" class="input-toss bg-white text-center" placeholder="권리자"></div><div class="col-span-3"><input type="text" id="bond2" class="input-toss bg-white" placeholder="0" onkeyup="formatMoney(this); autoCalcPrincipal(2)"></div><div class="col-span-2"><input type="number" id="ratio2" class="input-toss bg-white text-center" value="120" onchange="autoCalcPrincipal(2)"></div><div class="col-span-3"><input type="text" id="principal2" class="input-toss input-readonly" placeholder="0" readonly></div></div>
                                <div class="grid grid-cols-12 gap-2 mb-2 items-center"><div class="col-span-1 text-center font-bold text-sm">3순위</div><div class="col-span-3"><input type="text" id="bank3" class="input-toss bg-white text-center" placeholder="권리자"></div><div class="col-span-3"><input type="text" id="bond3" class="input-toss bg-white" placeholder="0" onkeyup="formatMoney(this); autoCalcPrincipal(3)"></div><div class="col-span-2"><input type="number" id="ratio3" class="input-toss bg-white text-center" value="120" onchange="autoCalcPrincipal(3)"></div><div class="col-span-3"><input type="text" id="principal3" class="input-toss input-readonly" placeholder="0" readonly></div></div>
                                <div class="grid grid-cols-12 gap-2 mb-2 items-center"><div class="col-span-1 text-center font-bold text-sm">4순위</div><div class="col-span-3"><input type="text" id="bank4" class="input-toss bg-white text-center" placeholder="권리자"></div><div class="col-span-3"><input type="text" id="bond4" class="input-toss bg-white" placeholder="0" onkeyup="formatMoney(this); autoCalcPrincipal(4)"></div><div class="col-span-2"><input type="number" id="ratio4" class="input-toss bg-white text-center" value="120" onchange="autoCalcPrincipal(4)"></div><div class="col-span-3"><input type="text" id="principal4" class="input-toss input-readonly" placeholder="0" readonly></div></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-white border-t border-gray-100 mt-auto">
                    <button onclick="callGeminiAnalysisAndSave()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-blue-700 shadow-lg transition flex justify-center items-center gap-2">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> AI 리포트 생성 및 저장
                    </button>
                </div>
            </section>
        </div>

        <section id="reportSection" class="mb-20">
            <div class="report-container relative">
                <div class="flex justify-between items-center border-b border-gray-200 pb-4 mb-6">
                    <h2 class="text-2xl font-extrabold text-[#191f28]"><i class="fa-solid fa-file-invoice-dollar text-blue-600 mr-2"></i>담백스퀘어(주) 대출비서 리포트</h2>
                    <div class="flex gap-2">
                        <button id="shareBtn" onclick="copyShareUrl()" class="hidden px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm font-bold shadow-md transition"><i class="fa-solid fa-link mr-1"></i> 공유 URL</button>
                        <button onclick="copyAnalysis()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-bold text-gray-600"><i class="fa-regular fa-copy mr-1"></i> 텍스트 복사</button>
                    </div>
                </div>
                <div id="aiReportContent" class="prose">
                    <div class="text-center py-20 text-gray-400"><i class="fa-solid fa-arrow-up text-4xl mb-4 opacity-30"></i><p class="text-lg">정보 입력 후 <strong>[AI 리포트 생성]</strong>을 눌러주세요.</p></div>
                </div>
            </div>
        </section>
    </main>

    <div id="loading" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl text-center shadow-xl"><i class="fa-solid fa-spinner fa-spin text-3xl text-blue-600 mb-3"></i><p class="font-bold">분석 중...</p></div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let globalPdfBlob = null;
        let globalPdfHex = "";
        let globalRegistryData = null; 
        let globalPdfText = "";        
        let globalOwnerName = "고객"; 
        let globalAddress = ""; 
        let currentReportId = ""; 

        window.addEventListener('DOMContentLoaded', loadSidebarHistory);

        const dropZone = document.getElementById('dropZone');
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); });
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); handleFileUpload(e.dataTransfer.files); });

        async function searchAddr() {
            const addr = document.getElementById('addrInput').value;
            if(!addr) return alert('주소를 입력하세요.');
            globalAddress = extractCleanAddress(addr);
            const area = document.getElementById('listArea');
            area.innerHTML = '<div class="h-full flex flex-col items-center justify-center"><i class="fa-solid fa-spinner fa-spin text-2xl text-blue-500"></i></div>';
            try {
                const res = await fetch('/api/search', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ address: addr }) });
                const data = await res.json();
                renderList(data.list || []);
            } catch(e) { area.innerHTML = '<p class="text-center mt-10 text-red-500">오류 발생</p>'; }
        }

        // [수정] 검색 결과 리스트 - 소유자 이름 3배 확대 및 선택 버튼 2배 확대
        function renderList(list) {
            const area = document.getElementById('listArea');
            area.innerHTML = '';
            if(!list || list.length === 0) { area.innerHTML = '<p class="text-center mt-10 text-gray-400">결과가 없습니다.</p>'; return; }
            list.forEach(item => {
                const addr = item.addr || item.roadAddr || item.simpleAddress || "주소없음";
                const owner = item.ownerNm || item.소유자 || "미표기";
                const uniqNo = item.uniqueNo || item.uniqNo || item.부동산고유번호;
                const div = document.createElement('div');
                div.className = "bg-white p-4 border rounded-lg hover:border-blue-500 cursor-pointer flex justify-between items-center shadow-sm transition-all";
                div.innerHTML = `
                    <div class="overflow-hidden mr-2 flex-1">
                        <div class="text-sm font-medium text-gray-500 truncate mb-1">${addr}</div>
                        <div class="flex flex-col">
                            <span class="text-2xl font-extrabold text-blue-700 tracking-tight">${owner}</span>
                            <span class="text-xs text-gray-400 mt-1">고유번호: ${uniqNo}</span>
                        </div>
                    </div>
                    <button onclick="globalOwnerName='${owner}'; issueDoc('${uniqNo}')" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-xl text-lg font-bold whitespace-nowrap shadow-md transition-all transform active:scale-95">
                        선택
                    </button>
                `;
                area.appendChild(div);
            });
        }

        // [수정] 발급 로직 보완 (API PDF 직접 추출)
        async function issueDoc(uniqNo) {
            if(!confirm("선택한 등기를 발급(포인트차감) 하시겠습니까?")) return;
            document.getElementById('loading').classList.remove('hidden');
            try {
                const res = await fetch('/api/issue', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ uniqNo: uniqNo }) });
                const data = await res.json();
                if(data.success) {
                    const bytes = new Uint8Array(data.pdfHex.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
                    globalPdfBlob = new Blob([bytes], {type: 'application/pdf'});
                    globalPdfHex = data.pdfHex;
                    globalRegistryData = data.info;
                    
                    document.getElementById('pdfControlPanel').classList.remove('hidden');
                    
                    const arrayBuffer = bytes.buffer;
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    let fullText = "";
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        fullText += textContent.items.map(item => item.str).join(" ") + "\n";
                    }
                    globalPdfText = fullText;

                    if (data.parsedArea) {
                        const areaInput = document.getElementById('areaInput');
                        areaInput.value = data.parsedArea;
                        areaInput.classList.add('auto-filled'); 
                        setTimeout(() => areaInput.classList.remove('auto-filled'), 1500);
                    }

                    autoParseData(fullText);
                    alert(`✅ 발급 완료!\n소유자: ${globalOwnerName}\n전용면적 ${data.parsedArea || '확인불가'}㎡ 입력됨`);
                } else { alert("실패: " + data.msg); }
            } catch(e) { console.error(e); alert("오류 발생"); }
            finally { document.getElementById('loading').classList.add('hidden'); }
        }

        async function handleFileUpload(files) {
            if (files.length === 0) return;
            const file = files[0];
            document.getElementById('loading').classList.remove('hidden');
            try {
                const arrayBuffer = await file.arrayBuffer();
                globalPdfBlob = new Blob([arrayBuffer], { type: 'application/pdf' });
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                let fullText = "";
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    fullText += textContent.items.map(item => item.str).join(" ") + "\n";
                }
                globalPdfText = fullText;
                autoParseData(fullText); 
                document.getElementById('pdfControlPanel').classList.remove('hidden');
                alert("✅ PDF 업로드 완료! (자동분석 완료)");
            } catch (e) { console.error(e); alert("PDF 오류"); }
            finally { document.getElementById('loading').classList.add('hidden'); }
        }

        function autoParseData(textData) {
            let parsedAddr = "";
            let match = textData.match(/\[집합건물\]\s+([^\n\r]+)/);
            if (match) {
                parsedAddr = match[1].split(/고유번호|표제부|1\.\s*소유지분/)[0].trim();
                document.getElementById('displayAddress').innerText = parsedAddr;
                globalAddress = extractCleanAddress(parsedAddr);
            }

            let parsedOwners = new Set();
            const summaryIdx = textData.indexOf("주요 등기사항 요약");
            if (summaryIdx !== -1) {
                 const summaryText = textData.substring(summaryIdx);
                 const ownerSectionStart = summaryText.indexOf("1. 소유지분현황");
                 const ownerSectionEnd = summaryText.indexOf("2. 소유지분을", ownerSectionStart);
                 if (ownerSectionStart !== -1 && ownerSectionEnd !== -1) {
                     const ownerSection = summaryText.substring(ownerSectionStart, ownerSectionEnd);
                     const ownerMatches = ownerSection.matchAll(/([가-힣]{2,10})\s*\(?(?:소유자|공유자|합유자)/g);
                     for (const m of ownerMatches) {
                         if (!["대상", "등기", "기록", "지분"].includes(m[1].trim())) {
                             parsedOwners.add(m[1].trim());
                         }
                     }
                 }
            } else {
                const m = textData.match(/소유자\s+([가-힣]{2,10})/);
                if (m) parsedOwners.add(m[1]);
            }
            if (parsedOwners.size > 0) {
                globalOwnerName = Array.from(parsedOwners).join(", ");
                document.getElementById('displayOwner').innerText = globalOwnerName;
            }

            const cleanText = textData.replace(/\s+/g, '');
            const areaParts = cleanText.split('전유부분');
            if (areaParts.length > 1) {
                const areaMatch = areaParts[1].match(/(\d+\.\d+)/);
                if (areaMatch) document.getElementById('areaInput').value = areaMatch[1];
            } else {
                 const backupMatch = textData.match(/전유부분.*?(\d+\.\d+)\s*m2/);
                 if (backupMatch) document.getElementById('areaInput').value = backupMatch[1];
            }

            const gapguSection = document.getElementById('gapguSection');
            const gapguList = document.getElementById('gapguList');
            gapguList.innerHTML = "";
            gapguSection.classList.add('hidden');
            if (summaryIdx !== -1) {
                const startKeyword = "2. 소유지분을 제외한 소유권에 관한 사항";
                const endKeyword = "3. (근)저당권"; 
                const startPos = textData.indexOf(startKeyword, summaryIdx);
                let endPos = textData.indexOf(endKeyword, summaryIdx);
                if (endPos === -1) {
                    const nextBracket = textData.indexOf("[", startPos + startKeyword.length);
                    endPos = nextBracket !== -1 ? nextBracket : textData.length;
                }
                if (startPos !== -1) {
                    const sectionText = textData.substring(startPos, endPos);
                    const cleanSectionText = sectionText.replace(/\s+/g, "");
                    if (!cleanSectionText.includes("기록사항없음")) {
                        const li = document.createElement('li');
                        li.className = "text-red-600 font-bold text-base animate-pulse";
                        li.innerText = "특이사항 압류, 가압류, 경매 등 확인필요!!";
                        gapguList.appendChild(li);
                        gapguSection.classList.remove('hidden');
                    }
                }
            }

            let loansMap = new Map();
            if (summaryIdx !== -1) {
                let summarySection = textData.substring(summaryIdx);
                const mortgageStart = summarySection.indexOf("3. (근)저당권");
                if (mortgageStart !== -1) {
                    const targetSection = summarySection.substring(mortgageStart).replace(/\n/g, " ");
                    const regex = /(\d+(?:-\d+)?)\s+.*?\s+금([0-9,]+)원/g;
                    let match;
                    while ((match = regex.exec(targetSection)) !== null) {
                        const fullRank = match[1];
                        const amountStr = match[2];
                        const baseRank = fullRank.split('-')[0];
                        const amt = parseInt(amountStr.replace(/,/g, ''));
                        let entry = loansMap.get(baseRank) || { amount: 0, holder: "" };
                        entry.amount = amt;
                        const afterText = targetSection.substring(regex.lastIndex, regex.lastIndex + 150);
                        const holderMatch = afterText.match(/근저당권자\s+([가-힣A-Za-z]+(?:주식회사)?)/);
                        if (holderMatch) entry.holder = holderMatch[1];
                        else if (!entry.holder) entry.holder = "확인필요";
                        loansMap.set(baseRank, entry);
                    }
                }
            }
            const loans = Array.from(loansMap.values()).filter(l => l.amount > 1000000).sort((a,b) => b.amount - a.amount).slice(0, 4);
            for(let i=1; i<=4; i++) {
                document.getElementById(`bank${i}`).value = "";
                document.getElementById(`bond${i}`).value = "";
                document.getElementById(`principal${i}`).value = "";
                document.getElementById(`ratio${i}`).value = "120";
            }
            for (let i = 0; i < loans.length; i++) {
                const amt = loans[i].amount;
                const manwon = Math.round(amt / 10000);
                const ratios = [110, 120, 115, 125, 130, 140, 150];
                let detectedRatio = 120;
                let detectedPrincipal = Math.round(amt / 1.2);
                for (let r of ratios) {
                    const tempPrin = amt / (r / 100);
                    if (Math.abs(tempPrin - Math.round(tempPrin)) < 100 && tempPrin % 1000 === 0) {
                        detectedRatio = r; detectedPrincipal = tempPrin; break; 
                    }
                }
                document.getElementById(`bank${i+1}`).value = loans[i].holder;
                document.getElementById(`bond${i+1}`).value = manwon.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                document.getElementById(`ratio${i+1}`).value = detectedRatio;
                document.getElementById(`principal${i+1}`).value = Math.round(detectedPrincipal/10000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                document.getElementById(`bank${i+1}`).classList.add('auto-filled');
            }
            setTimeout(() => { for(let i=1; i<=4; i++) document.getElementById(`bank${i}`).classList.remove('auto-filled'); }, 1000);
        }

        // [수정] 히스토리 완전 복원 기능
        async function callGeminiAnalysisAndSave() {
             const kbPrice = document.getElementById('kbPrice').value;
             const areaVal = document.getElementById('areaInput').value; 
             if(!globalRegistryData && !globalPdfText) return alert("데이터가 없습니다.");
             if(!kbPrice) return alert("KB 시세를 입력해주세요.");
             document.getElementById('loading').classList.remove('hidden');
             const loansData = [];
             for(let i=1; i<=4; i++) {
                 loansData.push({ 
                     bank: document.getElementById(`bank${i}`).value, 
                     bond: document.getElementById(`bond${i}`).value, 
                     ratio: document.getElementById(`ratio${i}`).value, 
                     prin: document.getElementById(`principal${i}`).value 
                 });
             }
             const loansForAnalysis = loansData.filter(l => l.bond).map((l, idx) => ({ rank: (idx+1)+"순위", bank: l.bank, bond: l.bond, ratio: l.ratio, principal: l.prin }));
             try {
                const res = await fetch('/api/analyze', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ registryData: globalRegistryData || { rawText: globalPdfText.substring(0, 5000) }, userInputs: { kbPrice: kbPrice, area: areaVal, loans: loansForAnalysis } }) });
                const data = await res.json();
                const aiResultHtml = marked.parse(data.analysis);
                document.getElementById('aiReportContent').innerHTML = aiResultHtml;
                const fullState = { id: crypto.randomUUID(), date: new Date().toLocaleString(), owner: globalOwnerName, address: globalAddress, aiText: aiResultHtml, pdfHex: globalPdfHex, inputs: { addr: document.getElementById('addrInput').value, area: areaVal, kb: kbPrice, loans: loansData }, gapguHtml: document.getElementById('gapguList').innerHTML };
                const shareRes = await fetch('/api/share', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ pdfHex: globalPdfHex, aiText: aiResultHtml, metaData: { owner: globalOwnerName, date: new Date().toLocaleDateString() } }) });
                const shareData = await shareRes.json();
                if (shareData.success) {
                    fullState.id = shareData.reportId;
                    currentReportId = shareData.reportId;
                    addToSidebarHistory(fullState);
                    document.getElementById('shareBtn').classList.remove('hidden');
                    document.getElementById('reportSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
             } catch(e) { console.error(e); alert("분석 중 오류 발생"); }
             finally { document.getElementById('loading').classList.add('hidden'); }
        }
        
        function addToSidebarHistory(item) {
            let history = JSON.parse(localStorage.getItem('consultHistory') || "[]");
            history = history.filter(h => h.id !== item.id);
            history.unshift(item);
            if (history.length > 20) history.pop();
            localStorage.setItem('consultHistory', JSON.stringify(history));
            loadSidebarHistory();
        }

        function restoreReport(item) {
            globalPdfHex = item.pdfHex || "";
            globalOwnerName = item.owner || "";
            globalAddress = item.address || "";
            currentReportId = item.id;
            if (globalPdfHex) {
                const bytes = new Uint8Array(globalPdfHex.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
                globalPdfBlob = new Blob([bytes], {type: 'application/pdf'});
                document.getElementById('pdfControlPanel').classList.remove('hidden');
            } else {
                globalPdfBlob = null;
                document.getElementById('pdfControlPanel').classList.add('hidden');
            }
            if (item.inputs) {
                document.getElementById('addrInput').value = item.inputs.addr || "";
                document.getElementById('areaInput').value = item.inputs.area || "";
                document.getElementById('kbPrice').value = item.inputs.kb || "";
                updateKoreanMoney(document.getElementById('kbPrice'));
                if (item.inputs.loans) {
                    item.inputs.loans.forEach((loan, idx) => {
                        const i = idx + 1;
                        if(i <= 4) {
                            document.getElementById(`bank${i}`).value = loan.bank || "";
                            document.getElementById(`bond${i}`).value = loan.bond || "";
                            document.getElementById(`ratio${i}`).value = loan.ratio || "";
                            document.getElementById(`principal${i}`).value = loan.prin || "";
                        }
                    });
                }
            }
            document.getElementById('displayOwner').innerText = globalOwnerName;
            document.getElementById('displayAddress').innerText = globalAddress;
            document.getElementById('aiReportContent').innerHTML = item.aiText;
            if (item.gapguHtml && item.gapguHtml.trim() !== "") {
                document.getElementById('gapguList').innerHTML = item.gapguHtml;
                document.getElementById('gapguSection').classList.remove('hidden');
            } else { document.getElementById('gapguList').innerHTML = ""; document.getElementById('gapguSection').classList.add('hidden'); }
            document.getElementById('shareBtn').classList.remove('hidden');
            document.getElementById('reportSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function updateKoreanMoney(input) {
    const val = parseInt(input.value.replace(/,/g, ''));
    const display = document.getElementById('kbKoreanText');
    
    if (!val || isNaN(val)) { 
        display.innerText = ""; 
        return; 
    }

    const uk = Math.floor(val / 10000); // 억 단위
    const man = val % 10000;           // 만원 단위

    let result = "";
    if (uk > 0) result += uk + "억 ";
    if (man > 0) {
        // 만원 단위가 0이 아닐 때만 표시
        result += man.toLocaleString() + "만원";
    } else if (uk > 0) {
        // 딱 몇 억으로 떨어질 경우 (예: 600,000 -> 60억)
        result = uk + "억 원";
    }

    display.innerText = result.trim();
}

        function openPdfViewer() { 
            if(!globalPdfBlob) return alert("PDF 파일이 없습니다.");
            const fileURL = window.URL.createObjectURL(globalPdfBlob);
            window.open(fileURL, '_blank', 'width=1000,height=900,scrollbars=yes,resizable=yes');
        }

        function extractCleanAddress(addr) { const match = addr.match(/(\S+[동리가])\s+(\d+(?:-\d+)?)/); return match ? match[0] : addr; }
        function formatMoney(e) { e.value = e.value.replace(/\D/g,'').replace(/\B(?=(\d{3})+(?!\d))/g, ','); }
        function autoCalcPrincipal(i) { 
            const bondEl = document.getElementById(`bond${i}`);
            const ratioEl = document.getElementById(`ratio${i}`);
            const prinEl = document.getElementById(`principal${i}`);
            const bond = (parseFloat(bondEl.value.replace(/,/g, '')) || 0) * 10000;
            const ratio = parseFloat(ratioEl.value) || 120;
            if(bond > 0 && ratio > 0) { const principal = Math.round(bond / (ratio / 100)); prinEl.value = Math.round(principal / 10000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); } else { prinEl.value = ""; }
        }

        function loadSidebarHistory() {
            const list = document.getElementById('historyList');
            const history = JSON.parse(localStorage.getItem('consultHistory') || "[]");
            list.innerHTML = "";
            if (history.length === 0) { list.innerHTML = '<div class="text-center text-gray-400 text-xs py-10">기록이 없습니다.</div>'; return; }
            history.forEach(h => {
                const div = document.createElement('div');
                div.className = "history-item";
                div.onclick = () => restoreReport(h);
                div.innerHTML = `<div class="flex justify-between items-start"><div class="font-bold text-gray-800 text-sm truncate w-24">${h.owner}</div><div class="text-[10px] text-gray-400">${h.date.split('. ')[1] || h.date}</div></div><div class="text-xs text-gray-500 truncate mt-1">${h.address}</div>`;
                list.appendChild(div);
            });
        }
        function savePdfAsCustom() { 
            if(!globalPdfBlob) return;
            const fileName = prompt("저장할 파일명 확인", `${globalOwnerName}_${globalAddress}_()`);
            if(fileName) { const a = document.createElement('a'); a.href = window.URL.createObjectURL(globalPdfBlob); a.download = fileName + ".pdf"; a.click(); }
        }
        function openKBLand() { 
            if (globalAddress) {
                const match = globalAddress.match(/(\S+[동읍면])\s+(\d+(?:-\d+)?)/);
                const copyText = match ? `${match[1]} ${match[2]}` : globalAddress;
                navigator.clipboard.writeText(copyText).then(() => {
                    alert(`'${copyText}' 복사완료!\nKB창에 붙여넣기(Ctrl+V) 하세요.`);
                    const width = 450; const height = 800;
                    const left = window.screen.width - width - 50; const top = 100;
                    window.open('https://kbland.kr/mobile', 'kbPopup', `width=${width},height=${height},left=${left},top=${top}`);
                }).catch(() => { window.open('https://kbland.kr/mobile', 'kbPopup', `width=450,height=800`); });
            } else { window.open('https://kbland.kr/mobile', 'kbPopup', 'width=450,height=800'); }
        }
        function copyAnalysis() { navigator.clipboard.writeText(document.getElementById('aiReportContent').innerText); alert("복사완료"); }
        function copyShareUrl() { if (!currentReportId) return alert("저장된 리포트가 없습니다."); const url = `${window.location.origin}/view.html?id=${currentReportId}`; navigator.clipboard.writeText(url).then(() => alert(`✅ URL 복사완료!\n${url}`)); }
        function clearHistory() { if(confirm("삭제하시겠습니까?")) { localStorage.removeItem('consultHistory'); loadSidebarHistory(); } }
    </script>
</body>
</html>